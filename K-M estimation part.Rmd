---
title: "K-M estimation part"
author: "Zhezheng Jin"
date: "2023-11-28"
output:
  html_document:
    df_print: paged
---
```{r setup, include=FALSE}
library(survival)
library(dplyr)
library(ggplot2)
library(survminer)
library(gtsummary)
```

## discription in two treatment

```{r}
head(rotterdam)
Rotterdam=data.frame(rotterdam)
stats <- Rotterdam %>% 
  mutate(
    treat = case_when(
      hormon == 0 ~ "Treat = 0",
      hormon == 1 ~ "Treat = 1")) 
stats <- stats %>% 
  bind_rows(stats %>% 
              mutate(treat = "Overall"))
stats %>%
  tbl_summary(by = treat) %>% 
   modify_caption("**People Characteristics in the Study**") %>%
  bold_labels()
```

## summary of variables

```{r}
char_table <- data.frame(
  Characteristic = c("year", "age", "meno", "grade", "nodes", "pgr", "er", "hormon", "chemo", "rtime", "recur", "dtime", "death"),
  Mean = NA,
  Median = NA,
  Min = NA,
  Max = NA,
  Sd = NA
)


for (i in 1:nrow(char_table)) {
  var_name <- char_table$Characteristic[i]
  char_table$Mean[i] <- mean(Rotterdam[[var_name]], na.rm = TRUE)
  char_table$Median[i] <- median(Rotterdam[[var_name]], na.rm = TRUE)
  char_table$Min[i] <- min(Rotterdam[[var_name]], na.rm = TRUE)
  char_table$Max[i] <- max(Rotterdam[[var_name]], na.rm = TRUE)
  char_table$Sd[i] <- sd(Rotterdam[[var_name]], na.rm = TRUE)
}

char_table
```

## KM estimation

```{r}
status  <- pmax(rotterdam$recur, rotterdam$death)
rfstime <- with(rotterdam, ifelse(recur==1, rtime, dtime))

surv_obj <- Surv(time = rfstime, event = status)

km_fit1 <- survfit(surv_obj ~ 1)
ggsurvplot(km_fit1, data=  rotterdam,                  
           pval = TRUE,                
           conf.int = TRUE,           
           risk.table = TRUE,          
           ggtheme = theme_minimal(),  
           palette = "Dark2",         
           main = "Kaplan-Meier Survival Curve", 
           xlab = "Time",              
           ylab = "Survival Probability") 
```


```{r}
km_fit2 <- survfit(surv_obj ~ Rotterdam$hormon)


ggsurvplot(km_fit2, data=  rotterdam,                  
           pval = TRUE,                
           conf.int = TRUE,           
           risk.table = TRUE,          
           ggtheme = theme_minimal(),  
           palette = "Dark2",         
           main = "Kaplan-Meier Survival Curve", 
           xlab = "Time",              
           ylab = "Survival Probability") 
```

The total number of subjects observed was 1546, among which 1080 experienced the event of interest
We can see from the Chisq and p-values here suggest that the non-linear relationships of these variables are significant. 